#!/usr/bin/env bash

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if sudo is available
SUDO=""
if command -v sudo &> /dev/null; then
    SUDO="sudo"
    echo -e "${GREEN}sudo detected${NC}"
else
    echo -e "${YELLOW}sudo not found - running without elevated privileges${NC}"
fi

# Detect package manager
detect_package_manager() {
    if command -v nala &> /dev/null; then
        echo "nala"
    elif command -v apt &> /dev/null; then
        echo "apt"
    elif command -v pkg &> /dev/null; then
        echo "pkg"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    elif command -v yum &> /dev/null; then
        echo "yum"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v zypper &> /dev/null; then
        echo "zypper"
    elif command -v apk &> /dev/null; then
        echo "apk"
    elif command -v brew &> /dev/null; then
        echo "brew"
    else
        echo -e "${RED}Error: No supported package manager found${NC}"
        exit 1
    fi
}

# Search packages based on package manager
search_packages() {
    local pm=$1
    case $pm in
        nala|apt)
            apt-cache search . | awk '{print $1}' | sort -u
            ;;
        pkg)
            pkg search . 2>/dev/null | awk '{print $1}' | sort -u
            ;;
        dnf|yum)
            $pm list available 2>/dev/null | awk 'NR>1 {print $1}' | sed 's/\..*//' | sort -u
            ;;
        pacman)
            pacman -Sl | awk '{print $2}' | sort -u
            ;;
        zypper)
            zypper search -t package 2>/dev/null | awk 'NR>4 && /^[^-]/ {print $3}' | sort -u
            ;;
        apk)
            apk search -q
            ;;
        brew)
            brew search
            ;;
    esac
}

# Get package info for preview
get_package_info() {
    local pm=$1
    local pkg=$2
    
    case $pm in
        nala|apt)
            apt-cache show "$pkg" 2>/dev/null | head -50
            ;;
        pkg)
            pkg show "$pkg" 2>/dev/null
            ;;
        dnf|yum)
            $pm info "$pkg" 2>/dev/null
            ;;
        pacman)
            pacman -Si "$pkg" 2>/dev/null
            ;;
        zypper)
            zypper info "$pkg" 2>/dev/null
            ;;
        apk)
            apk info -d "$pkg" 2>/dev/null
            ;;
        brew)
            brew info "$pkg" 2>/dev/null
            ;;
    esac
}

# Check if package is already installed
check_installed() {
    local pm=$1
    local pkg=$2
    
    case $pm in
        nala|apt)
            dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"
            ;;
        pkg)
            pkg list-installed 2>/dev/null | grep -q "^$pkg/"
            ;;
        dnf|yum)
            $pm list installed "$pkg" &>/dev/null
            ;;
        pacman)
            pacman -Q "$pkg" &>/dev/null
            ;;
        zypper)
            zypper se -i "$pkg" 2>/dev/null | grep -q "^i"
            ;;
        apk)
            apk info -e "$pkg" &>/dev/null
            ;;
        brew)
            brew list "$pkg" &>/dev/null
            ;;
    esac
}

# Install package
install_package() {
    local pm=$1
    local pkg=$2
    
    # Check if already installed
    if check_installed "$pm" "$pkg"; then
        echo -e "${YELLOW}⊙ $pkg is already installed, skipping...${NC}"
        return 0
    fi
    
    echo -e "${BLUE}Installing $pkg...${NC}"
    
    case $pm in
        nala)
            $SUDO nala install "$pkg"
            ;;
        apt)
            $SUDO apt update && $SUDO apt install "$pkg"
            ;;
        pkg)
            pkg install "$pkg"
            ;;
        dnf)
            $SUDO dnf install "$pkg"
            ;;
        yum)
            $SUDO yum install "$pkg"
            ;;
        pacman)
            $SUDO pacman -S "$pkg"
            ;;
        zypper)
            $SUDO zypper install "$pkg"
            ;;
        apk)
            $SUDO apk add "$pkg"
            ;;
        brew)
            brew install "$pkg"
            ;;
    esac
}

# Main
main() {
    # Show help
    if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
        echo "Usage: $0 [PACKAGE_NAME...]"
        echo ""
        echo "Interactive mode (with fzf):"
        echo "  $0"
        echo ""
        echo "Direct installation mode:"
        echo "  $0 htop neofetch curl"
        echo ""
        echo "Options:"
        echo "  -h, --help    Show this help message"
        exit 0
    fi
    
    echo -e "${GREEN}Detecting package manager...${NC}"
    PM=$(detect_package_manager)
    echo -e "${GREEN}Found: $PM${NC}"
    echo ""
    
    # Check if packages were provided as arguments
    if [ $# -gt 0 ]; then
        echo -e "${BLUE}Installing packages from command line arguments...${NC}"
        echo ""
        
        # Build list of packages to install (skip already installed)
        PACKAGES_TO_INSTALL=""
        for pkg in "$@"; do
            if check_installed "$PM" "$pkg"; then
                echo -e "${YELLOW}⊙ $pkg is already installed, skipping...${NC}"
            else
                PACKAGES_TO_INSTALL="$PACKAGES_TO_INSTALL $pkg"
            fi
        done
        
        # Install all packages at once if there are any
        if [ -n "$PACKAGES_TO_INSTALL" ]; then
            echo ""
            echo -e "${BLUE}Installing:$PACKAGES_TO_INSTALL${NC}"
            
            case $PM in
                nala)
                    $SUDO nala install $PACKAGES_TO_INSTALL
                    ;;
                apt)
                    $SUDO apt update && $SUDO apt install $PACKAGES_TO_INSTALL
                    ;;
                pkg)
                    pkg install $PACKAGES_TO_INSTALL
                    ;;
                dnf)
                    $SUDO dnf install $PACKAGES_TO_INSTALL
                    ;;
                yum)
                    $SUDO yum install $PACKAGES_TO_INSTALL
                    ;;
                pacman)
                    $SUDO pacman -S $PACKAGES_TO_INSTALL
                    ;;
                zypper)
                    $SUDO zypper install $PACKAGES_TO_INSTALL
                    ;;
                apk)
                    $SUDO apk add $PACKAGES_TO_INSTALL
                    ;;
                brew)
                    brew install $PACKAGES_TO_INSTALL
                    ;;
            esac
            
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓ Successfully installed packages${NC}"
            else
                echo -e "${RED}✗ Installation failed${NC}"
            fi
        else
            echo -e "${YELLOW}All specified packages are already installed.${NC}"
        fi
        
        echo -e "${GREEN}Done!${NC}"
        return 0
    fi
    
    # Check if fzf is installed (only needed for interactive mode)
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}Error: fzf is not installed${NC}"
        echo "Install it with your package manager first, or use: $0 PACKAGE_NAME"
        exit 1
    fi
    
    # Interactive mode with fzf
    echo -e "${YELLOW}Loading package list... (this may take a moment)${NC}"
    
    # Export functions and variables for fzf preview
    export -f get_package_info
    export -f check_installed
    export PM
    export SUDO
    export RED GREEN YELLOW BLUE NC
    
    # Use fzf to select package with preview
    SELECTED=$(search_packages "$PM" | fzf \
        --height=80% \
        --border \
        --preview="bash -c 'get_package_info \"\$PM\" {}'" \
        --preview-window=right:60%:wrap \
        --header="Select package to install (Tab for multi-select, Enter to confirm)" \
        --multi \
        --bind='ctrl-/:toggle-preview' \
        --prompt="Search packages: ")
    
    # Check if user selected anything
    if [ -z "$SELECTED" ]; then
        echo -e "${YELLOW}No package selected. Exiting.${NC}"
        exit 0
    fi
    
    # Install selected packages
    echo ""
    echo -e "${GREEN}Selected packages:${NC}"
    echo "$SELECTED"
    echo ""
    
    # Build list of packages to install (skip already installed)
    PACKAGES_TO_INSTALL=""
    while IFS= read -r pkg; do
        if check_installed "$PM" "$pkg"; then
            echo -e "${YELLOW}⊙ $pkg is already installed, skipping...${NC}"
        else
            PACKAGES_TO_INSTALL="$PACKAGES_TO_INSTALL $pkg"
        fi
    done <<< "$SELECTED"
    
    # Install all packages at once if there are any
    if [ -n "$PACKAGES_TO_INSTALL" ]; then
        echo ""
        echo -e "${BLUE}Installing:$PACKAGES_TO_INSTALL${NC}"
        
        case $PM in
            nala)
                $SUDO nala install $PACKAGES_TO_INSTALL
                ;;
            apt)
                $SUDO apt update && $SUDO apt install $PACKAGES_TO_INSTALL
                ;;
            pkg)
                pkg install $PACKAGES_TO_INSTALL
                ;;
            dnf)
                $SUDO dnf install $PACKAGES_TO_INSTALL
                ;;
            yum)
                $SUDO yum install $PACKAGES_TO_INSTALL
                ;;
            pacman)
                $SUDO pacman -S $PACKAGES_TO_INSTALL
                ;;
            zypper)
                $SUDO zypper install $PACKAGES_TO_INSTALL
                ;;
            apk)
                $SUDO apk add $PACKAGES_TO_INSTALL
                ;;
            brew)
                brew install $PACKAGES_TO_INSTALL
                ;;
        esac
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ Successfully installed packages${NC}"
        else
            echo -e "${RED}✗ Installation failed${NC}"
        fi
    else
        echo -e "${YELLOW}All selected packages are already installed.${NC}"
    fi
    
    echo -e "${GREEN}Done!${NC}"
}

main "$@"
