#!/usr/bin/env bash

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if sudo is available
SUDO=""
if command -v sudo &> /dev/null; then
    SUDO="sudo"
    echo -e "${GREEN}sudo detected${NC}"
else
    echo -e "${YELLOW}sudo not found - running without elevated privileges${NC}"
fi

# Detect package manager
detect_package_manager() {
    if command -v nala &> /dev/null; then
        echo "nala"
    elif command -v apt &> /dev/null; then
        echo "apt"
    elif command -v pkg &> /dev/null; then
        echo "pkg"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    elif command -v yum &> /dev/null; then
        echo "yum"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v zypper &> /dev/null; then
        echo "zypper"
    elif command -v apk &> /dev/null; then
        echo "apk"
    elif command -v brew &> /dev/null; then
        echo "brew"
    else
        echo -e "${RED}Error: No supported package manager found${NC}"
        exit 1
    fi
}

# List installed packages based on package manager
list_installed_packages() {
    local pm=$1
    case $pm in
        nala|apt)
            dpkg -l | grep "^ii" | awk '{print $2}' | sort -u
            ;;
        pkg)
            pkg list-installed 2>/dev/null | awk -F'/' '{print $1}' | sort -u
            ;;
        dnf|yum)
            # Use rpm for faster listing
            rpm -qa --qf '%{NAME}\n' 2>/dev/null | sort -u
            ;;
        pacman)
            pacman -Q | awk '{print $1}' | sort -u
            ;;
        zypper)
            zypper se -i 2>/dev/null | awk 'NR>4 && /^i/ {print $3}' | sort -u
            ;;
        apk)
            apk info 2>/dev/null | sort -u
            ;;
        brew)
            brew list --formula | sort -u
            ;;
    esac
}

# Get package info for preview
get_package_info() {
    local pm=$1
    local pkg=$2
    
    case $pm in
        nala|apt)
            dpkg -s "$pkg" 2>/dev/null
            echo ""
            echo "--- Package Description ---"
            apt-cache show "$pkg" 2>/dev/null | grep -A 20 "^Description"
            ;;
        pkg)
            pkg show "$pkg" 2>/dev/null
            ;;
        dnf|yum)
            # Show installed package info first, then general info
            if rpm -q "$pkg" &>/dev/null; then
                echo "=== Installed Package ==="
                rpm -qi "$pkg" 2>/dev/null
                echo ""
            fi
            echo "=== Package Info ==="
            $pm info "$pkg" 2>/dev/null
            ;;
        pacman)
            pacman -Qi "$pkg" 2>/dev/null
            ;;
        zypper)
            zypper info -t package "$pkg" 2>/dev/null
            ;;
        apk)
            apk info "$pkg" 2>/dev/null
            ;;
        brew)
            brew info "$pkg" 2>/dev/null
            ;;
    esac
}

# Check if package is installed
check_installed() {
    local pm=$1
    local pkg=$2
    
    case $pm in
        nala|apt)
            dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"
            ;;
        pkg)
            pkg list-installed 2>/dev/null | grep -q "^$pkg/"
            ;;
        dnf|yum)
            # Use rpm for faster and more reliable check
            rpm -q "$pkg" &>/dev/null
            ;;
        pacman)
            pacman -Q "$pkg" &>/dev/null
            ;;
        zypper)
            zypper se -i "$pkg" 2>/dev/null | grep -q "^i"
            ;;
        apk)
            apk info -e "$pkg" &>/dev/null
            ;;
        brew)
            brew list "$pkg" &>/dev/null
            ;;
    esac
}

# Remove package
remove_package() {
    local pm=$1
    local pkg=$2
    
    # Check if package is installed
    if ! check_installed "$pm" "$pkg"; then
        echo -e "${YELLOW}⊙ $pkg is not installed, skipping...${NC}"
        return 0
    fi
    
    echo -e "${RED}Removing $pkg...${NC}"
    
    case $pm in
        nala)
            $SUDO nala remove -y "$pkg"
            ;;
        apt)
            $SUDO apt remove -y "$pkg"
            ;;
        pkg)
            pkg uninstall -y "$pkg"
            ;;
        dnf)
            $SUDO dnf remove -y "$pkg"
            ;;
        yum)
            $SUDO yum remove -y "$pkg"
            ;;
        pacman)
            $SUDO pacman -R --noconfirm "$pkg"
            ;;
        zypper)
            $SUDO zypper remove -y "$pkg"
            ;;
        apk)
            $SUDO apk del "$pkg"
            ;;
        brew)
            brew uninstall "$pkg"
            ;;
    esac
}

# Main
main() {
    # Show help
    if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
        echo "Usage: $0 [PACKAGE_NAME...]"
        echo ""
        echo "Interactive mode (with fzf):"
        echo "  $0"
        echo ""
        echo "Direct removal mode:"
        echo "  $0 htop neofetch curl"
        echo ""
        echo "Options:"
        echo "  -h, --help    Show this help message"
        exit 0
    fi
    
    echo -e "${GREEN}Detecting package manager...${NC}"
    PM=$(detect_package_manager)
    echo -e "${GREEN}Found: $PM${NC}"
    echo ""
    
    # Check if packages were provided as arguments
    if [ $# -gt 0 ]; then
        echo -e "${RED}Removing packages from command line arguments...${NC}"
        echo ""
        
        # Show packages to be removed
        echo -e "${YELLOW}Packages to remove:${NC}"
        for pkg in "$@"; do
            echo "  - $pkg"
        done
        echo ""
        
        # Ask for confirmation
        read -p "Remove these packages? [y/N] " -n 1 -r
        echo
        
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            # Build list of packages to remove (skip not installed)
            PACKAGES_TO_REMOVE=""
            for pkg in "$@"; do
                if ! check_installed "$PM" "$pkg"; then
                    echo -e "${YELLOW}⊙ $pkg is not installed, skipping...${NC}"
                else
                    PACKAGES_TO_REMOVE="$PACKAGES_TO_REMOVE $pkg"
                fi
            done
            
            # Remove all packages at once if there are any
            if [ -n "$PACKAGES_TO_REMOVE" ]; then
                echo ""
                echo -e "${RED}Removing:$PACKAGES_TO_REMOVE${NC}"
                
                case $PM in
                    nala)
                        $SUDO nala remove -y $PACKAGES_TO_REMOVE
                        ;;
                    apt)
                        $SUDO apt remove -y $PACKAGES_TO_REMOVE
                        ;;
                    pkg)
                        pkg uninstall -y $PACKAGES_TO_REMOVE
                        ;;
                    dnf)
                        $SUDO dnf remove -y $PACKAGES_TO_REMOVE
                        ;;
                    yum)
                        $SUDO yum remove -y $PACKAGES_TO_REMOVE
                        ;;
                    pacman)
                        $SUDO pacman -R --noconfirm $PACKAGES_TO_REMOVE
                        ;;
                    zypper)
                        $SUDO zypper remove -y $PACKAGES_TO_REMOVE
                        ;;
                    apk)
                        $SUDO apk del $PACKAGES_TO_REMOVE
                        ;;
                    brew)
                        brew uninstall $PACKAGES_TO_REMOVE
                        ;;
                esac
                
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✓ Successfully removed packages${NC}"
                else
                    echo -e "${RED}✗ Removal failed${NC}"
                fi
            else
                echo -e "${YELLOW}None of the specified packages are installed.${NC}"
            fi
            
            echo -e "${GREEN}Done!${NC}"
        else
            echo -e "${YELLOW}Removal cancelled.${NC}"
        fi
        return 0
    fi
    
    # Check if fzf is installed (only needed for interactive mode)
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}Error: fzf is not installed${NC}"
        echo "Install it with your package manager first, or use: $0 PACKAGE_NAME"
        exit 1
    fi
    
    # Interactive mode with fzf
    echo -e "${YELLOW}Loading installed packages list...${NC}"
    
    # Export functions and variables for fzf preview
    export -f get_package_info
    export -f check_installed
    export PM
    export SUDO
    export RED GREEN YELLOW BLUE NC
    
    # Use fzf to select package with preview
    SELECTED=$(list_installed_packages "$PM" | fzf \
        --height=80% \
        --border \
        --preview="bash -c 'get_package_info \"\$PM\" {}'" \
        --preview-window=right:60%:wrap \
        --header="Select packages to REMOVE (Tab for multi-select, Enter to confirm)" \
        --multi \
        --bind='ctrl-/:toggle-preview' \
        --prompt="Search installed packages: ")
    
    # Check if user selected anything
    if [ -z "$SELECTED" ]; then
        echo -e "${YELLOW}No package selected. Exiting.${NC}"
        exit 0
    fi
    
    # Remove selected packages
    echo ""
    echo -e "${RED}Selected packages for REMOVAL:${NC}"
    echo "$SELECTED"
    echo ""
    
    read -p "Remove these packages? [y/N] " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Build list of packages to remove (skip not installed)
        PACKAGES_TO_REMOVE=""
        while IFS= read -r pkg; do
            if ! check_installed "$PM" "$pkg"; then
                echo -e "${YELLOW}⊙ $pkg is not installed, skipping...${NC}"
            else
                PACKAGES_TO_REMOVE="$PACKAGES_TO_REMOVE $pkg"
            fi
        done <<< "$SELECTED"
        
        # Remove all packages at once if there are any
        if [ -n "$PACKAGES_TO_REMOVE" ]; then
            echo ""
            echo -e "${RED}Removing:$PACKAGES_TO_REMOVE${NC}"
            
            case $PM in
                nala)
                    $SUDO nala remove -y $PACKAGES_TO_REMOVE
                    ;;
                apt)
                    $SUDO apt remove -y $PACKAGES_TO_REMOVE
                    ;;
                pkg)
                    pkg uninstall -y $PACKAGES_TO_REMOVE
                    ;;
                dnf)
                    $SUDO dnf remove -y $PACKAGES_TO_REMOVE
                    ;;
                yum)
                    $SUDO yum remove -y $PACKAGES_TO_REMOVE
                    ;;
                pacman)
                    $SUDO pacman -R --noconfirm $PACKAGES_TO_REMOVE
                    ;;
                zypper)
                    $SUDO zypper remove -y $PACKAGES_TO_REMOVE
                    ;;
                apk)
                    $SUDO apk del $PACKAGES_TO_REMOVE
                    ;;
                brew)
                    brew uninstall $PACKAGES_TO_REMOVE
                    ;;
            esac
            
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓ Successfully removed packages${NC}"
            else
                echo -e "${RED}✗ Removal failed${NC}"
            fi
        else
            echo -e "${YELLOW}None of the selected packages are installed.${NC}"
        fi
        
        echo -e "${GREEN}Done!${NC}"
    else
        echo -e "${YELLOW}Removal cancelled.${NC}"
    fi
}

main "$@"
